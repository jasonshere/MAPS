{% extends "include/__layout.html" %}

{% block styles %}
    {{super()}}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.9.0/fullcalendar.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.9.0/fullcalendar.print.css" rel='stylesheet' media='print'>
    <link rel="stylesheet" href="{{url_for('static', filename='css/calendar.css')}}">
{% endblock %}

{% block mybody %}
<div class="content-wrapper">
    <div class="row">
        <div class="col-lg-12">
        <div class="card">
            <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                <!-- <button class="btn btn-primary btn-block"> -->
                    <!-- <i class="mdi mdi-plus"></i> Create A New event</button> -->
                <!-- <div class="wrapper mt-4">
                    <div class="item-wrapper d-flex pb-4 border-bottom">
                    <div class="status-wrapper d-flex align-items-start pr-3">
                        <span class="bg-warning rounded-circle p-1 mt-2 mx-auto"></span>
                    </div>
                    <div class="text-wrapper">
                        <h6 class="d-block mb-1">Dentist appoinment:metro</h6>
                        <small class="d-block mb-2">
                        <strong>7 Feb 2017, 16:00</strong>
                        </small>
                        <small class="text-gray d-block">First Remainder : 1 Hours min before</small>
                    </div>
                    </div>
                    <div class="item-wrapper d-flex py-4">
                    <div class="status-wrapper d-flex align-items-start pr-3">
                        <span class="bg-success rounded-circle p-1 mt-2 mx-auto"></span>
                    </div>
                    <div class="text-wrapper">
                        <h6 class="d-block mb-1">Job appoinment:metro</h6>
                        <small class="d-block mb-2">
                        <strong>9 Feb 2017, 20:00</strong>
                        </small>
                        <small class="text-gray d-block">First Remainder : 1 Hours min before</small>
                    </div>
                    </div>
                </div> -->
                <div class="wrapper">
                    <div class="wrapper d-flex justify-content-between align-items-center mb-4">
                    <div class="d-flex align-items-center">
                        <small class="font-weight-bold mr-2 mb-0">Doctors</small>
                        <!-- <div class="badge badge-inverse-primary badge-pill">2</div> -->
                    </div>
                    <span class="text-gray">
                        <i class="mdi mdi-dots-horizontal"></i>
                    </span>
                    </div>
                    <div class="calendar-aside">
                    {% for doctor in doctors %}
                    <div class="list" id="{{doctor.id}}">
                        <img class="img-xs rounded-circle" src="{{url_for('static', filename='images/faces/face2.jpg')}}" alt="profile image">
                        <span class="user-text">{{doctor.username}}</span>
                        <span class="count online ml-auto">
                        <i class="close ml-auto mdi mdi-close-circle-outline"></i>
                        </span>
                    </div>
                    {% endfor %}
                    
                    </div>
                </div>
                </div>
                <div class="col-md-8">
                <div id="calendar"></div>
                </div>
            </div>
            </div>
        </div>
        </div>
    </div>
</div>
<!-- Modal -->
<div class="modal fade" id="confirm" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
        <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLongTitle">Confirm Appointment</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
            </button>
        </div>
        <div class="modal-body">
            <div class="table-responsive">
                <table class="table table-hover table-striped table-bordered">
                    <tbody>
                    <tr>
                        <th>Doctor</th>
                        <td id="doctor_name"></td>
                    </tr>
                    <tr>
                        <th>Patient</th>
                        <td>Jacob</td>
                    </tr>
                    <tr>
                        <th>Time</th>
                        <td><label class="badge badge-danger" id="appTime">12 May 2017</label></td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div class="modal-footer">
            <input type="hidden" name="doctor_id" value="">
            <input type="hidden" name="doctor_email" value="">
            <input type="hidden" name="patient_id" value="{{session.User.id}}">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            <button type="button" id="sub" class="btn btn-primary">Save changes</button>
        </div>
        </div>
    </div>
    </div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script src="{{url_for('static', filename='js/hoverable-collapse.js')}}"></script>
    <script>
            (function($) {
                'use strict';
                $(function() {
                var style = getComputedStyle(document.body);
                var myEvents = [
                    {
                        start: '2018-09-18T10:00:00',
                        end: '2018-09-18T16:00:00',
                        rendering: 'background'
                    }
                ]
                if ($('#calendar').length) {
                    $('#calendar').fullCalendar({
                    defaultView: 'agendaFourDay',
                    views: {
                        agendaFourDay: {
                            type: 'agenda',
                            duration: { days: 7 }
                        }
                    },
                    header: {
                        left: 'prev,next today',
                        center: 'title',
                        right: 'agendaFourDay,month,basicWeek,basicDay'
                    },
                    selectable: true,
                    eventClick: function(calEvent, jsEvent, view) {
                        // id = calEvent.id
                        let url = "{{url_for('patient.deleteEvents')}}" 
                        $.post(url, {"event_id": calEvent.id}, function(data){
                            if(data.code == 1)
                                $('#calendar').fullCalendar( 'removeEvents', [calEvent.id] )
                        })
                    },
                    select: function(startDate, endDate) {
                        var doctor_id = $(":input[name=doctor_id]").val()
                        var doctor_email = $(":input[name=doctor_email]").val()
                        var patient_id = $(":input[name=patient_id]").val()
                        var start = startDate.format()
                        var end = endDate.format()
                        $("#sub").click(function(){
                            $.post('{{url_for("patient.setEvents")}}', {
                                "start": start,
                                "end": end,
                                "patient_id": patient_id,
                                "doctor_id": doctor_id,
                                "doctor_email": doctor_email,
                                "patient_email": "{{session.User.email}}"
                            }, function(res){
                                if(res.code == 1){
                                    $('#calendar').fullCalendar('renderEvent', {
                                        title: 'See the doctor',
                                        start: start,
                                        end: end,
                                        id: res.data.id,
                                        allDay: false
                                    });
                                }
                            })
                        })
                        $('#confirm').modal('show')
                    },
                    defaultDate: new Date(),
                    navLinks: true, // can click day/week names to navigate views
                    editable: true,
                    eventLimit: true, // allow "more" link when too many events
                    eventBackgroundColor: 'red',
                    events: myEvents
                    })
                }
                });
            })(jQuery);
            $(function(){
                $(".list").click(function(){
                    $('#calendar').fullCalendar('removeEvents')
                    var id = $(this).attr("id")
                    $(":input[name=doctor_id]").val(id)
                    var doctor = $.getJSON('/patient/get_doctor/'+id, function(res){
                        $("#doctor_name").html(res.data.username);
                        $(":input[name=doctor_email]").val(res.data.email)
                    })
                    var url = "/patient/get_busytime/"+id
                    $.getJSON(url, function(res){
                        for(var i in res.data) {
                            $('#calendar').fullCalendar('renderEvent', {
                                title: 'Not Available',
                                start: res.data[i]['start'],
                                end: res.data[i]['end'],
                                id: res.data[i]['id'],
                                allDay: false
                            });
                        }
                    })

                    var url = "/patient/get_events/"+id
                    $.getJSON(url, function(res){
                        if (res.code == 1) {
                            for(var i in res.data) {
                                start = res.data[i]['start']['dateTime']
                                end = res.data[i]['end']['dateTime']
                                $('#calendar').fullCalendar('renderEvent', {
                                    title: 'Not Available',
                                    start: start,
                                    end: end,
                                    id: id,
                                    allDay: false
                                });
                            }
                        }
                    })
                })
                $.getJSON('{{url_for("patient.getEvents")}}', function(res){
                    if (res.code == 1) {
                        for(var i in res.data) {
                            $('#calendar').fullCalendar('renderEvent', {
                                title: 'See the doctor',
                                start: res.data[i].start['dateTime'],
                                end: res.data[i].end['dateTime'],
                                id: res.data[i]['id'],
                                allDay: false
                            });
                        }
                    }
                })
            })
        </script>
{% endblock %}